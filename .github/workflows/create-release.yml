name: Create Release Draft

on:
  push:
    tags:
      - 'v*' # Trigger when you push a tag like v1.0.0

permissions:
  contents: write

jobs:
  create_draft:
    name: Create Draft Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important: Fetch all history to see commits

      - name: Generate Release Notes
        id: notes
        run: |
          # 1. Identify Tags
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          # Try to find the previous tag. If none, it's empty.
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")
          
          echo "Current Tag: $CURRENT_TAG"
          echo "Previous Tag: $PREVIOUS_TAG"

          # 2. Start the Note
          echo "## ðŸš€ Changes in $CURRENT_TAG" > release_body.md
          echo "" >> release_body.md
          
          # 3. List Commits
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "### Initial Release" >> release_body.md
            # List all commits for the first release
            git log --pretty=format:"- %s" >> release_body.md
          else
            echo "### ðŸ“ Commits" >> release_body.md
            # List commits between previous tag and this one (excluding merges)
            git log --pretty=format:"- %s" $PREVIOUS_TAG..$CURRENT_TAG --no-merges >> release_body.md
          fi
          
          echo "" >> release_body.md
          echo "---" >> release_body.md
          echo "Generated by GitHub Actions" >> release_body.md

          # 4. Save for the next step
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          cat release_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true # Create as Draft so you can review it
          prerelease: false
          body: ${{ steps.notes.outputs.BODY }}
          generate_release_notes: false # Disable the native "PR-only" generator
