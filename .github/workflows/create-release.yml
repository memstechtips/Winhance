name: Create Release Draft

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create_draft:
    name: Create Draft Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Release Number
        id: release_number
        run: |
          # Get the latest release number from GitHub API
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            | grep '"name":' \
            | head -1 \
            | sed -E 's/.*#([0-9]+).*/\1/')

          # If no previous release found, start at 1
          if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" = "null" ]; then
            NEXT_NUMBER=1
          else
            NEXT_NUMBER=$((LATEST_RELEASE + 1))
          fi

          echo "next_number=$NEXT_NUMBER" >> $GITHUB_OUTPUT
          echo "Next release number: #$NEXT_NUMBER"

      - name: Generate Release Notes
        id: notes
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")

          echo "Current Tag: $CURRENT_TAG"
          echo "Previous Tag: $PREVIOUS_TAG"

          # Start building the release notes
          echo "## ðŸš€ Changes in $CURRENT_TAG" > release_body.md
          echo "" >> release_body.md

          # Get commits and categorize them
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"%s" $PREVIOUS_TAG..$CURRENT_TAG --no-merges)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "^feat:" | sed 's/^feat: /- /' || true)
          FIXES=$(echo "$COMMITS" | grep -i "^fix:" | sed 's/^fix: /- /' || true)
          REFACTORS=$(echo "$COMMITS" | grep -i "^refactor:" | sed 's/^refactor: /- /' || true)
          DOCS=$(echo "$COMMITS" | grep -i "^docs:" | sed 's/^docs: /- /' || true)
          PERF=$(echo "$COMMITS" | grep -i "^perf:" | sed 's/^perf: /- /' || true)
          STYLE=$(echo "$COMMITS" | grep -i "^style:" | sed 's/^style: /- /' || true)
          CHORE=$(echo "$COMMITS" | grep -i "^chore:" | sed 's/^chore: /- /' || true)
          OTHER=$(echo "$COMMITS" | grep -iv "^feat:\|^fix:\|^refactor:\|^docs:\|^perf:\|^style:\|^chore:" | sed 's/^/- /' || true)

          # Add categorized sections (only if they have content)
          if [ ! -z "$FEATURES" ]; then
            echo "### âœ¨ Features" >> release_body.md
            echo "$FEATURES" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> release_body.md
            echo "$FIXES" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$REFACTORS" ]; then
            echo "### â™»ï¸ Refactoring" >> release_body.md
            echo "$REFACTORS" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$PERF" ]; then
            echo "### âš¡ Performance" >> release_body.md
            echo "$PERF" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$DOCS" ]; then
            echo "### ðŸ“š Documentation" >> release_body.md
            echo "$DOCS" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$STYLE" ]; then
            echo "### ðŸ’„ Style" >> release_body.md
            echo "$STYLE" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$CHORE" ]; then
            echo "### ðŸ”§ Chores" >> release_body.md
            echo "$CHORE" >> release_body.md
            echo "" >> release_body.md
          fi

          if [ ! -z "$OTHER" ]; then
            echo "### ðŸ“ Other Changes" >> release_body.md
            echo "$OTHER" >> release_body.md
            echo "" >> release_body.md
          fi

          # Add standard sections
          cat >> release_body.md << 'NOTES_END'
          ## Localization ðŸŒ

          I used AI (Gemini 2.5 Pro) to generate initial translations for Winhance, so it's available in multiple languages right out of the gate. That said, AI isn't perfect, and there are probably some mistakes or awkward phrasings in there.

          If you spot any translation errors or have suggestions to make things sound more natural, I'd love your help! Feel free to open a Pull Request with corrections or create an Issue to let me know what needs fixing. The localization files can be found in the `src/Winhance.WPF/Localization` directory.

          Want to see Winhance in a language that's not currently supported? Open an Issue with the "feature request" label and I'll see what I can do!

          ## ðŸ“¥ Installation
          Download from [winhance.net](https://winhance.net) or directly from this release.
          NOTES_END

          # Save for next step (using multi-line output)
          {
            echo "BODY<<EOF"
            cat release_body.md
            echo "EOF"
          } >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: false
          name: "Winhance Release #${{ steps.release_number.outputs.next_number }} ${{ github.ref_name }}"
          body: ${{ steps.notes.outputs.BODY }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
