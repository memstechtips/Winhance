using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Win32;
using Winhance.Core.Features.Common.Interfaces;
using Winhance.Core.Features.Common.Models;
using Winhance.Core.Features.Common.Enums;
using Winhance.WPF.Features.Common.ViewModels;
using Winhance.WPF.Features.Common.Models;
using Winhance.WPF.Features.Common.Resources.Theme;
using Winhance.WPF.Features.Optimize.ViewModels;
using Winhance.WPF.Features.Common.Views;
using Winhance.WPF.Features.Common.Messages;

namespace Winhance.WPF.Features.Customize.ViewModels
{
    /// <summary>
    /// Clean Architecture implementation of the ViewModel for the Customize view.
    /// </summary>
    public partial class CustomizeViewModel : BaseSettingsViewModel
    {
        // Store a backup of all items for state recovery
        private List<ApplicationSettingItem> _allItemsBackup = new List<ApplicationSettingItem>();
        private bool _isInitialSearchDone = false;

        // Tracks if search has any results
        [ObservableProperty]
        private bool _hasSearchResults = true;
        private readonly ISystemServices _windowsService;
        private readonly IDialogService _dialogService;
        private readonly IThemeManager _themeManager;
        private readonly IConfigurationService _configurationService;
        private readonly IMessengerService _messengerService;
        private readonly ILogService _logService;

        /// <summary>
        /// Gets the messenger service.
        /// </summary>
        public IMessengerService MessengerService => _messengerService;

        // Flag to prevent cascading checkbox updates
        private bool _updatingCheckboxes = false;
        
        /// <summary>
        /// Gets or sets a value indicating whether dark mode is enabled.
        /// </summary>
        [ObservableProperty]
        private bool _isDarkModeEnabled;

        /// <summary>
        /// Gets or sets a value indicating whether all settings are selected.
        /// </summary>
        [ObservableProperty]
        private bool _isSelectAllSelected;

        /// <summary>
        /// Gets or sets a value indicating whether settings are being loaded.
        /// </summary>
        [ObservableProperty]
        private bool _isLoading;

        /// <summary>
        /// Gets or sets the status text.
        /// </summary>
        [ObservableProperty]
        private string _statusText = "Customize Your Windows Appearance and Behaviour";
        
        // Override the SearchText property to add explicit notification and direct control over the search flow
        private string _searchTextOverride = string.Empty;
        public new string SearchText
        {
            get => _searchTextOverride;
            set
            {
                if (_searchTextOverride != value)
                {
                    _searchTextOverride = value;
                    OnPropertyChanged(nameof(SearchText));
                    LogInfo($"CustomizeViewModel: SearchText changed to: '{value}'");
                    
                    // Explicitly update IsSearchActive and call ApplySearch
                    IsSearchActive = !string.IsNullOrWhiteSpace(value);
                    ApplySearch();
                    
                    // Update status text based on search results
                    if (IsSearchActive)
                    {
                        StatusText = $"Found {Items.Count} settings matching '{value}'";
                    }
                    else
                    {
                        StatusText = "Customize Your Windows Appearance and Behaviour";
                    }
                }
            }
        }

        /// <summary>
        /// Gets the collection of customization items.
        /// </summary>
        public ObservableCollection<ApplicationSettingGroup> CustomizationItems { get; } = new();

        /// <summary>
        /// Gets or sets the taskbar settings view model.
        /// </summary>
        [ObservableProperty]
        private TaskbarCustomizationsViewModel _taskbarSettings;

        /// <summary>
        /// Gets or sets the start menu settings view model.
        /// </summary>
        [ObservableProperty]
        private StartMenuCustomizationsViewModel _startMenuSettings;

        /// <summary>
        /// Gets or sets the explorer customizations view model.
        /// </summary>
        [ObservableProperty]
        private ExplorerCustomizationsViewModel _explorerSettings;

        /// <summary>
        /// Gets or sets the Windows theme customizations view model.
        /// </summary>
        [ObservableProperty]
        private WindowsThemeCustomizationsViewModel _windowsThemeSettings;

        /// <summary>
        /// Gets a value indicating whether the view model is initialized.
        /// </summary>
        public bool IsInitialized { get; private set; }

        /// <summary>
        /// Gets the initialize command.
        /// </summary>
        public AsyncRelayCommand InitializeCommand { get; }

        /// <summary>
        /// Initializes a new instance of the <see cref="CustomizeViewModel"/> class.
        /// </summary>
        /// <param name="progressService">The task progress service.</param>
        /// <param name="windowsService">The Windows service.</param>
        /// <param name="logService">The log service.</param>
        /// <param name="dialogService">The dialog service.</param>
        /// <param name="themeManager">The theme manager.</param>
        /// <param name="searchService">The search service.</param>
        /// <param name="configurationService">The configuration service.</param>
        /// <param name="taskbarSettings">The taskbar customizations view model.</param>
        /// <param name="startMenuSettings">The start menu customizations view model.</param>
        /// <param name="explorerSettings">The explorer settings view model.</param>
        /// <param name="windowsThemeSettings">The Windows theme customizations view model.</param>
        /// <param name="messengerService">The messenger service.</param>
        public CustomizeViewModel(
            ITaskProgressService progressService,
            ISystemServices windowsService,
            ILogService logService,
            IDialogService dialogService,
            IThemeManager themeManager,
            ISearchService searchService,
            IConfigurationService configurationService,
            TaskbarCustomizationsViewModel taskbarSettings,
            StartMenuCustomizationsViewModel startMenuSettings,
            ExplorerCustomizationsViewModel explorerSettings,
            WindowsThemeCustomizationsViewModel windowsThemeSettings,
            IMessengerService messengerService)
            : base(progressService, searchService, null)
        {
            _windowsService = windowsService ?? throw new ArgumentNullException(nameof(windowsService));
            _dialogService = dialogService ?? throw new ArgumentNullException(nameof(dialogService));
            _themeManager = themeManager ?? throw new ArgumentNullException(nameof(themeManager));
            _configurationService = configurationService ?? throw new ArgumentNullException(nameof(configurationService));
            _messengerService = messengerService ?? throw new ArgumentNullException(nameof(messengerService));
            _logService = logService ?? throw new ArgumentNullException(nameof(logService));

            TaskbarSettings = taskbarSettings ?? throw new ArgumentNullException(nameof(taskbarSettings));
            StartMenuSettings = startMenuSettings ?? throw new ArgumentNullException(nameof(startMenuSettings));
            ExplorerSettings = explorerSettings ?? throw new ArgumentNullException(nameof(explorerSettings));
            WindowsThemeSettings = windowsThemeSettings ?? throw new ArgumentNullException(nameof(windowsThemeSettings));

            InitializeCustomizationItems();
            
            // Sync with WindowsThemeSettings
            IsDarkModeEnabled = WindowsThemeSettings.IsDarkModeEnabled;
            
            // Subscribe to WindowsThemeSettings property changes
            WindowsThemeSettings.PropertyChanged += (s, e) =>
            {
                if (e.PropertyName == nameof(WindowsThemeSettings.IsDarkModeEnabled))
                {
                    // Sync dark mode state with WindowsThemeSettings
                    IsDarkModeEnabled = WindowsThemeSettings.IsDarkModeEnabled;
                }
            };

            // Create initialize command
            InitializeCommand = new AsyncRelayCommand(InitializeAsync);
        }

        /// <summary>
        /// Initializes a new instance of the <see cref="CustomizeViewModel"/> class for design-time use.
        /// </summary>
        public CustomizeViewModel()
            : base(null, null, null)
        {
            // Design-time constructor
            IsInitialized = true;
            InitializeCommand = new AsyncRelayCommand(InitializeAsync);
        }

        /// <summary>
        /// Called when the view model is navigated to.
        /// </summary>
        /// <param name="parameter">The navigation parameter.</param>
        public void OnNavigatedTo(object parameter)
        {
            // Initialize if not already done
            if (!IsInitialized)
            {
                InitializeCommand.ExecuteAsync(null);
            }
        }

        /// <summary>
        /// Initializes the view model asynchronously.
        /// </summary>
        /// <param name="cancellationToken">The cancellation token.</param>
        /// <returns>A task representing the asynchronous operation.</returns>
        private async Task InitializeAsync()
        {
            if (IsInitialized)
            {
                return;
            }

            try
            {
                IsLoading = true;
                StatusText = "Loading customization settings...";

                // Initialize all child view models
                await Task.WhenAll(
                    TaskbarSettings.InitializeCommand.ExecuteAsync(null),
                    StartMenuSettings.InitializeCommand.ExecuteAsync(null),
                    ExplorerSettings.InitializeCommand.ExecuteAsync(null),
                    WindowsThemeSettings.InitializeCommand.ExecuteAsync(null)
                );

                // Set up property change handlers after initialization
                SetupPropertyChangeHandlers();

                // Load items
                await LoadItemsAsync();

                // Mark as initialized
                IsInitialized = true;
                StatusText = "Customization settings loaded successfully";
            }
            catch (Exception ex)
            {
                LogError($"Error initializing CustomizeViewModel: {ex.Message}");
                StatusText = "Error loading customization settings";
            }
            finally
            {
                IsLoading = false;
            }
        }

        /// <summary>
        /// Initializes the customization items.
        /// </summary>
        private void InitializeCustomizationItems()
        {
            CustomizationItems.Clear();

            // Add customization categories
            CustomizationItems.Add(new ApplicationSettingGroup
            {
                Name = "Taskbar",
                Description = "Customize the Windows taskbar appearance and behavior",
                IsSelected = false,
                IsVisible = true
            });

            CustomizationItems.Add(new ApplicationSettingGroup
            {
                Name = "Start Menu",
                Description = "Customize the Windows Start Menu appearance and behavior",
                IsSelected = false,
                IsVisible = true
            });

            CustomizationItems.Add(new ApplicationSettingGroup
            {
                Name = "Explorer",
                Description = "Customize Windows Explorer appearance and behavior",
                IsSelected = false,
                IsVisible = true
            });

            CustomizationItems.Add(new ApplicationSettingGroup
            {
                Name = "Windows Theme",
                Description = "Customize Windows theme, colors, and visual effects",
                IsSelected = false,
                IsVisible = true
            });
        }

        /// <summary>
        /// Sets up property change handlers.
        /// </summary>
        private void SetupPropertyChangeHandlers()
        {
            // Handle category selection changes
            foreach (var category in CustomizationItems)
            {
                category.PropertyChanged += (sender, e) =>
                {
                    if (e.PropertyName == nameof(ApplicationSettingGroup.IsSelected) && !_updatingCheckboxes)
                    {
                        var changedCategory = (ApplicationSettingGroup)sender;
                        UpdateCategorySettings(changedCategory);
                        UpdateSelectAllState();
                    }
                };
            }

            // Handle settings changes in child view models
            TaskbarSettings.PropertyChanged += (sender, e) => UpdateCategorySelectionState("Taskbar");
            StartMenuSettings.PropertyChanged += (sender, e) => UpdateCategorySelectionState("Start Menu");
            ExplorerSettings.PropertyChanged += (sender, e) => UpdateCategorySelectionState("Explorer");
            WindowsThemeSettings.PropertyChanged += (sender, e) => UpdateCategorySelectionState("Windows Theme");
        }

        /// <summary>
        /// Updates the settings for a category.
        /// </summary>
        /// <param name="category">The category.</param>
        private void UpdateCategorySettings(ApplicationSettingGroup category)
        {
            _updatingCheckboxes = true;

            try
            {
                switch (category.Name)
                {
                    case "Taskbar":
                        foreach (var setting in TaskbarSettings.Settings)
                        {
                            setting.IsSelected = category.IsSelected;
                        }
                        break;

                    case "Start Menu":
                        foreach (var setting in StartMenuSettings.Settings)
                        {
                            setting.IsSelected = category.IsSelected;
                        }
                        break;

                    case "Explorer":
                        foreach (var setting in ExplorerSettings.Settings)
                        {
                            setting.IsSelected = category.IsSelected;
                        }
                        break;

                    case "Windows Theme":
                        foreach (var setting in WindowsThemeSettings.Settings)
                        {
                            setting.IsSelected = category.IsSelected;
                        }
                        break;
                }
            }
            finally
            {
                _updatingCheckboxes = false;
            }
        }

        /// <summary>
        /// Updates the category selection state.
        /// </summary>
        /// <param name="categoryName">The category name.</param>
        private void UpdateCategorySelectionState(string categoryName)
        {
            if (_updatingCheckboxes)
            {
                return;
            }

            _updatingCheckboxes = true;

            try
            {
                var category = CustomizationItems.FirstOrDefault(c => c.Name == categoryName);
                if (category == null)
                {
                    return;
                }

                bool allSelected = false;
                bool anySelected = false;

                switch (categoryName)
                {
                    case "Taskbar":
                        allSelected = TaskbarSettings.Settings.All(s => s.IsSelected);
                        anySelected = TaskbarSettings.Settings.Any(s => s.IsSelected);
                        break;

                    case "Start Menu":
                        allSelected = StartMenuSettings.Settings.All(s => s.IsSelected);
                        anySelected = StartMenuSettings.Settings.Any(s => s.IsSelected);
                        break;

                    case "Explorer":
                        allSelected = ExplorerSettings.Settings.All(s => s.IsSelected);
                        anySelected = ExplorerSettings.Settings.Any(s => s.IsSelected);
                        break;

                    case "Windows Theme":
                        allSelected = WindowsThemeSettings.Settings.All(s => s.IsSelected);
                        anySelected = WindowsThemeSettings.Settings.Any(s => s.IsSelected);
                        break;
                }

                category.IsSelected = allSelected;
                category.IsIndeterminate = anySelected && !allSelected;

                UpdateSelectAllState();
            }
            finally
            {
                _updatingCheckboxes = false;
            }
        }

        /// <summary>
        /// Updates the select all state.
        /// </summary>
        private void UpdateSelectAllState()
        {
            if (_updatingCheckboxes)
            {
                return;
            }

            _updatingCheckboxes = true;

            try
            {
                bool allSelected = CustomizationItems.All(c => c.IsSelected);
                bool anySelected = CustomizationItems.Any(c => c.IsSelected);
                bool anyIndeterminate = CustomizationItems.Any(c => c.IsIndeterminate);

                IsSelectAllSelected = allSelected;
                // If we had an IsSelectAllIndeterminate property, we would set it here
            }
            finally
            {
                _updatingCheckboxes = false;
            }
        }

        /// <summary>
        /// Refreshes the Windows GUI.
        /// </summary>
        /// <returns>A task representing the asynchronous operation.</returns>
        private async Task RefreshWindowsGUI()
        {
            try
            {
                StatusText = "Refreshing Windows GUI...";
                await _windowsService.RefreshDesktopAsync();
                StatusText = "Windows GUI refreshed successfully";
            }
            catch (Exception ex)
            {
                LogError($"Error refreshing Windows GUI: {ex.Message}");
                StatusText = "Error refreshing Windows GUI";
            }
        }

        /// <summary>
        /// Toggles the select all state.
        /// </summary>
        [RelayCommand]
        private void ToggleSelectAll()
        {
            if (_updatingCheckboxes)
            {
                return;
            }

            _updatingCheckboxes = true;

            try
            {
                bool newState = !IsSelectAllSelected;
                IsSelectAllSelected = newState;

                foreach (var category in CustomizationItems)
                {
                    category.IsSelected = newState;
                    category.IsIndeterminate = false;
                    UpdateCategorySettings(category);
                }
            }
            finally
            {
                _updatingCheckboxes = false;
            }
        }

        /// <summary>
        /// Executes a customization action.
        /// </summary>
        /// <param name="action">The action to execute.</param>
        [RelayCommand]
        private async Task ExecuteAction(string action)
        {
            try
            {
                StatusText = $"Executing {action}...";
                IsLoading = true;

                switch (action)
                {
                    case "RefreshGUI":
                        await RefreshWindowsGUI();
                        break;

                    case "ApplySelected":
                        // Apply all selected settings
                        var tasks = new List<Task>();

                        if (TaskbarSettings.Settings.Any(s => s.IsSelected))
                        {
                            tasks.Add(TaskbarSettings.ApplySelectedCommand.ExecuteAsync(null));
                        }

                        if (StartMenuSettings.Settings.Any(s => s.IsSelected))
                        {
                            tasks.Add(StartMenuSettings.ApplySelectedCommand.ExecuteAsync(null));
                        }

                        if (ExplorerSettings.Settings.Any(s => s.IsSelected))
                        {
                            tasks.Add(ExplorerSettings.ApplySelectedCommand.ExecuteAsync(null));
                        }

                        if (WindowsThemeSettings.Settings.Any(s => s.IsSelected))
                        {
                            tasks.Add(WindowsThemeSettings.ApplySelectedCommand.ExecuteAsync(null));
                        }

                        await Task.WhenAll(tasks);
                        StatusText = "Selected settings applied successfully";
                        break;
                }
            }
            catch (Exception ex)
            {
                LogError($"Error executing action {action}: {ex.Message}");
                StatusText = $"Error executing {action}";
            }
            finally
            {
                IsLoading = false;
            }
        }

        /// <summary>
        /// Toggles a category.
        /// </summary>
        /// <param name="category">The category to toggle.</param>
        [RelayCommand]
        private void ToggleCategory(ApplicationSettingGroup category)
        {
            if (_updatingCheckboxes)
            {
                return;
            }

            _updatingCheckboxes = true;

            try
            {
                // Toggle the category
                category.IsSelected = !category.IsSelected;
                category.IsIndeterminate = false;

                // Update all settings in the category
                UpdateCategorySettings(category);

                // Update the select all state
                UpdateSelectAllState();
            }
            finally
            {
                _updatingCheckboxes = false;
            }
        }

        /// <summary>
        /// Loads items asynchronously.
        /// </summary>
        /// <returns>A task representing the asynchronous operation.</returns>
        private async Task LoadItemsAsync()
        {
            try
            {
                IsLoading = true;
                StatusText = "Loading customization settings...";

                // Clear existing items
                Items.Clear();
                _allItemsBackup.Clear();

                // Add settings from all child view models
                foreach (var setting in TaskbarSettings.Settings)
                {
                    Items.Add(setting);
                    _allItemsBackup.Add(setting);
                }

                foreach (var setting in StartMenuSettings.Settings)
                {
                    Items.Add(setting);
                    _allItemsBackup.Add(setting);
                }

                foreach (var setting in ExplorerSettings.Settings)
                {
                    Items.Add(setting);
                    _allItemsBackup.Add(setting);
                }

                foreach (var setting in WindowsThemeSettings.Settings)
                {
                    Items.Add(setting);
                    _allItemsBackup.Add(setting);
                }

                // Update category selection states
                foreach (var categoryName in new[] { "Taskbar", "Start Menu", "Explorer", "Windows Theme" })
                {
                    UpdateCategorySelectionState(categoryName);
                }

                // Update select all state
                UpdateSelectAllState();

                StatusText = $"Loaded {Items.Count} customization settings";
            }
            catch (Exception ex)
            {
                LogError($"Error loading items: {ex.Message}");
                StatusText = "Error loading customization settings";
            }
            finally
            {
                IsLoading = false;
            }
        }

        /// <summary>
        /// Checks the installation status of items asynchronously.
        /// </summary>
        /// <returns>A task representing the asynchronous operation.</returns>
        private async Task CheckInstallationStatusAsync()
        {
            // This method is a placeholder for compatibility with the base class
            await Task.CompletedTask;
        }

        /// <summary>
        /// Restores all items visibility to their original state.
        /// </summary>
        private void RestoreAllItemsVisibility()
        {
            // Reset all items visibility
            foreach (var item in Items)
            {
                item.IsVisible = true;
            }

            // Reset all categories visibility
            foreach (var category in CustomizationItems)
            {
                category.IsVisible = true;
            }

            // Reset HasVisibleSettings for all child view models
            if (TaskbarSettings != null)
            {
                TaskbarSettings.HasVisibleSettings = TaskbarSettings.Settings.Count > 0;
                foreach (var setting in TaskbarSettings.Settings)
                {
                    setting.IsVisible = true;
                }
            }

            if (StartMenuSettings != null)
            {
                StartMenuSettings.HasVisibleSettings = StartMenuSettings.Settings.Count > 0;
                foreach (var setting in StartMenuSettings.Settings)
                {
                    setting.IsVisible = true;
                }
            }

            if (ExplorerSettings != null)
            {
                ExplorerSettings.HasVisibleSettings = ExplorerSettings.Settings.Count > 0;
                foreach (var setting in ExplorerSettings.Settings)
                {
                    setting.IsVisible = true;
                }
            }

            if (WindowsThemeSettings != null)
            {
                WindowsThemeSettings.HasVisibleSettings = WindowsThemeSettings.Settings.Count > 0;
                foreach (var setting in WindowsThemeSettings.Settings)
                {
                    setting.IsVisible = true;
                }
            }

            // Update HasSearchResults
            HasSearchResults = true;
        }

        /// <summary>
        /// Applies the current search text to filter items.
        /// </summary>
        private void ApplySearch()
        {
            if (!IsInitialized || Settings == null)
            {
                return;
            }

            // If search is not active, restore all items visibility
            if (string.IsNullOrWhiteSpace(SearchText))
            {
                RestoreAllItemsVisibility();
                return;
            }

            // Create a HashSet to store IDs of items that match the search criteria
            var filteredItemIds = new HashSet<string>();
            
            // Filter items based on search text
            var searchTerms = SearchText.ToLower().Split(' ', StringSplitOptions.RemoveEmptyEntries);
            
            // First pass: identify all items that match the search criteria
            foreach (var item in _allItemsBackup)
            {
                bool matchesAllTerms = true;
                
                foreach (var term in searchTerms)
                {
                    bool matchesTerm = false;
                    
                    // Check if the item matches the current term
                    if (item.Name.ToLower().Contains(term) || 
                        item.Description.ToLower().Contains(term) ||
                        (item.Category != null && item.Category.ToLower().Contains(term)))
                    {
                        matchesTerm = true;
                    }
                    
                    // If the item doesn't match the current term, it doesn't match all terms
                    if (!matchesTerm)
                    {
                        matchesAllTerms = false;
                        break;
                    }
                }
                
                // If the item matches all terms, add its ID to the filtered items
                if (matchesAllTerms)
                {
                    filteredItemIds.Add(item.Id);
                }
            }
            
            // Second pass: update visibility of items in the Settings collection
            Settings.Clear();
            int visibleItemsCount = 0;
            
            // Update sub-view models with filtered items
            UpdateSubViewSettings(TaskbarSettings, filteredItemIds);
            UpdateSubViewSettings(StartMenuSettings, filteredItemIds);
            UpdateSubViewSettings(ExplorerSettings, filteredItemIds);
            UpdateSubViewSettings(WindowsThemeSettings, filteredItemIds);
            
            // Add all visible items to the Items collection
            foreach (var setting in _allItemsBackup.Where(s => s.IsVisible))
            {
                visibleItemsCount++;
                Settings.Add(setting);
            }
            
            // Update HasSearchResults
            HasSearchResults = visibleItemsCount > 0;
            
            // Update status text with correct count
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                StatusText = $"Found {visibleItemsCount} settings matching '{SearchText}'";
                LogInfo($"CustomizeViewModel: StatusText updated to: '{StatusText}' with {visibleItemsCount} visible items");
            }
            else
            {
                StatusText = $"Showing all {Items.Count} customization settings";
                LogInfo($"CustomizeViewModel: StatusText updated to: '{StatusText}'");
            }
        }

        /// <summary>
        /// Updates a sub-view model's Settings collection based on filtered items.
        /// </summary>
        /// <param name="viewModel">The sub-view model to update.</param>
        /// <param name="filteredItemIds">HashSet of IDs of items that match the search criteria.</param>
        private void UpdateSubViewSettings(BaseSettingsViewModel viewModel, HashSet<string> filteredItemIds)
        {
            if (viewModel == null || viewModel.Settings == null)
                return;

            // If not searching, show all settings
            if (!IsSearchActive)
            {
                foreach (var setting in viewModel.Settings)
                {
                    setting.IsVisible = true;
                }
                
                // Update the view model's visibility
                viewModel.HasVisibleSettings = viewModel.Settings.Count > 0;
                
                // Update the corresponding CustomizationItem
                var item = CustomizationItems.FirstOrDefault(i => i.Name == viewModel.CategoryName);
                if (item != null)
                {
                    item.IsVisible = true;
                }
                
                LogInfo($"CustomizeViewModel: Set all settings visible in {viewModel.CategoryName}");
                return;
            }

            // When searching, only show settings that match the search criteria
            bool hasVisibleSettings = false;
            int visibleCount = 0;
            
            foreach (var setting in viewModel.Settings)
            {
                // Check if this setting is in the filtered items
                setting.IsVisible = filteredItemIds.Contains(setting.Id);
                
                if (setting.IsVisible)
                {
                    hasVisibleSettings = true;
                    visibleCount++;
                }
            }
            
            // Update the view model's visibility
            viewModel.HasVisibleSettings = hasVisibleSettings;
            
            // Update the corresponding CustomizationItem - this is critical for proper UI behavior
            var categoryItem = CustomizationItems.FirstOrDefault(i => i.Name == viewModel.CategoryName);
            if (categoryItem != null)
            {
                categoryItem.IsVisible = hasVisibleSettings;
                LogInfo($"CustomizeViewModel: Setting CustomizationItem '{categoryItem.Name}' visibility to {hasVisibleSettings}");
            }
            
            LogInfo($"CustomizeViewModel: {viewModel.CategoryName} has {visibleCount} visible settings, HasVisibleSettings={hasVisibleSettings}");
        }

        /// <summary>
        /// Logs an informational message.
        /// </summary>
        /// <param name="message">The message to log.</param>
        private void LogInfo(string message)
        {
            StatusText = message;
            _logService?.Log(LogLevel.Info, message);
        }

        /// <summary>
        /// Logs an error message.
        /// </summary>
        /// <param name="message">The message to log.</param>
        private void LogError(string message)
        {
            StatusText = message;
            _logService?.Log(LogLevel.Error, message);
        }

        /// <summary>
        /// Gets the application settings that this ViewModel manages.
        /// </summary>
        /// <returns>Collection of application settings for all customizations.</returns>
        protected override async Task<IEnumerable<ApplicationSetting>> GetApplicationSettingsAsync()
        {
            // Return all settings from all categories
            var allSettings = new List<ApplicationSetting>();
            
            var startMenuSettings = await _settingsService.GetStartMenuSettingsAsync();
            var taskbarSettings = await _settingsService.GetTaskbarSettingsAsync();
            var explorerSettings = await _settingsService.GetExplorerSettingsAsync();
            var themeSettings = await _settingsService.GetThemeSettingsAsync();
            
            allSettings.AddRange(startMenuSettings);
            allSettings.AddRange(taskbarSettings);
            allSettings.AddRange(explorerSettings);
            allSettings.AddRange(themeSettings);
            
            return allSettings;
        }
    }
}
