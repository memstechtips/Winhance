<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:Winhance.WPF.Features.Common.Controls"
    xmlns:behaviors="clr-namespace:Winhance.WPF.Features.Common.Behaviors"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks">

    <!-- Section Containers -->
    <Style x:Key="ContentSectionStyle" TargetType="Border">
        <Setter Property="Background" Value="{DynamicResource ContentSectionBorderBrush}"/>
        <Setter Property="CornerRadius" Value="5"/>
        <Setter Property="Margin" Value="5"/>
        <Setter Property="Effect">
            <Setter.Value>
                <DropShadowEffect ShadowDepth="5" BlurRadius="10" Color="Black" Opacity="0.5"/>
            </Setter.Value>
        </Setter>
    </Style>

    <Style x:Key="MainContentBorderStyle" TargetType="Border">
        <Setter Property="Background" Value="{DynamicResource MainContainerBorderBrush}"/>
        <Setter Property="CornerRadius" Value="10"/>
        <Setter Property="Margin" Value="0,5,0,0"/>
    </Style>

    <!-- App Item Styles -->
    <Style x:Key="AppSectionHeaderStyle" TargetType="Border">
        <Setter Property="Background" Value="{DynamicResource ContentSectionBorderBrush}"/>
        <Setter Property="CornerRadius" Value="5"/>
        <Setter Property="Margin" Value="0,5,0,5"/>
        <Setter Property="Effect" Value="{StaticResource ShadowEffect}"/>
        <Setter Property="Cursor" Value="Hand"/>
    </Style>

    <Style x:Key="AppSectionHeaderTextStyle" TargetType="TextBlock">
        <Setter Property="HorizontalAlignment" Value="Left"/>
        <Setter Property="VerticalAlignment" Value="Center"/>
        <Setter Property="FontSize" Value="18"/>
        <Setter Property="FontWeight" Value="Bold"/>
        <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
        <Setter Property="Padding" Value="10"/>
        <Setter Property="DockPanel.Dock" Value="Left"/>
    </Style>

    <Style x:Key="AppSectionHeaderIconStyle" TargetType="TextBlock">
        <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
        <Setter Property="HorizontalAlignment" Value="Right"/>
        <Setter Property="VerticalAlignment" Value="Center"/>
        <Setter Property="FontSize" Value="16"/>
        <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
        <Setter Property="Padding" Value="10"/>
        <Setter Property="DockPanel.Dock" Value="Right"/>
    </Style>

    <Style x:Key="AppSectionContentBorderStyle" TargetType="Border">
        <Setter Property="Background" Value="{DynamicResource ContentSectionBorderBrush}"/>
        <Setter Property="CornerRadius" Value="5"/>
        <Setter Property="Margin" Value="5,0,5,5"/>
        <Setter Property="Effect" Value="{StaticResource LightShadowEffect}"/>
    </Style>

    <!-- List Containers -->
    <Style x:Key="ListViewContainerStyle" TargetType="ListView">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
        <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
        <Setter Property="Padding" Value="0"/>
        <Setter Property="Margin" Value="0"/>
    </Style>

    <!-- Panel Containers -->
    <Style x:Key="ContentStackPanelStyle" TargetType="StackPanel">
        <Setter Property="Margin" Value="10"/>
    </Style>

    <Style x:Key="HeaderStackPanelStyle" TargetType="StackPanel">
        <Setter Property="VerticalAlignment" Value="Center"/>
    </Style>

    <!-- Grid Containers -->
    <Style x:Key="ContentGridStyle" TargetType="Grid">
        <Setter Property="Margin" Value="10"/>
    </Style>

    <Style x:Key="SectionGridStyle" TargetType="Grid">
        <Setter Property="Margin" Value="10,5"/>
    </Style>

    <!-- FEATURE SECTION TEMPLATES -->
    <!-- Collapsible Header Template -->
    <ControlTemplate x:Key="CollapsibleHeaderTemplate" TargetType="ContentControl">
        <Border x:Name="HeaderBorder" Background="{DynamicResource ContentSectionBorderBrush}" CornerRadius="5" Margin="0,5,0,5" Effect="{StaticResource ShadowEffect}" Cursor="Hand" ClipToBounds="False" Panel.ZIndex="100">
            <Border.InputBindings>
                <MouseBinding MouseAction="LeftClick" Command="{Binding ToggleExpandCommand}"/>
            </Border.InputBindings>
            <Grid x:Name="Header" Height="40">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left content -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left" Grid.Column="0">
                    <!-- Category Icon -->
                    <ContentPresenter Content="{Binding}" Margin="15,6,5,6" VerticalAlignment="Center"/>
                    <!-- Category Name -->
                    <TextBlock Text="{Binding DisplayName}" FontSize="14" FontWeight="SemiBold" Margin="5,6,0,6" Foreground="{DynamicResource PrimaryTextColor}" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Chevron - positioned in right column with fixed alignment -->
                <iconPacks:PackIconMaterial x:Name="HeaderIcon" Kind="ChevronDown" Width="12" Height="12" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="{DynamicResource PrimaryTextColor}" Margin="0,0,15,0" Grid.Column="1" RenderTransformOrigin="0.5,0.5">
                    <iconPacks:PackIconMaterial.RenderTransform>
                        <RotateTransform Angle="{Binding IsExpanded, Converter={StaticResource BooleanToRotationConverter}}"/>
                    </iconPacks:PackIconMaterial.RenderTransform>
                </iconPacks:PackIconMaterial>
            </Grid>
        </Border>
    </ControlTemplate>

    <!-- Modern Settings Item Template (Card-style layout) -->
    <DataTemplate x:Key="ModernSettingsItemTemplate">
        <!-- Group header template -->
        <Grid>

            <!-- Setting Card Wrapper -->
            <Border Background="{DynamicResource SettingsItemBackground}" CornerRadius="4" Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="{Binding IsSubSetting, Converter={StaticResource SubSettingMarginConverter}}" Opacity="{Binding EffectiveIsEnabled, Converter={StaticResource BooleanToOpacityConverter}}">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Effect" Value="{StaticResource UltraLightShadowEffect}"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding EffectiveIsEnabled}" Value="False">
                                <Setter Property="Effect" Value="{x:Null}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Setting Text and Description (Left-aligned) with Icon -->
                    <StackPanel Grid.Column="0" HorizontalAlignment="Left" VerticalAlignment="Center" Orientation="Horizontal" Margin="15,7,0,7">
                        <!-- Setting Icon -->
                        <ContentControl VerticalAlignment="Center" Margin="0,0,15,0"
                                        Visibility="{Binding Icon, Converter={StaticResource InverseNullToVisibilityConverter}}">
                            <ContentControl.Content>
                                <MultiBinding Converter="{StaticResource IconPackConverter}">
                                    <Binding Path="IconPack"/>
                                    <Binding Path="Icon"/>
                                </MultiBinding>
                            </ContentControl.Content>
                            <ContentControl.Resources>
                                <Style TargetType="iconPacks:PackIconMaterial">
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
                                </Style>
                                <Style TargetType="iconPacks:PackIconMaterialDesign">
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
                                </Style>
                                <Style TargetType="iconPacks:PackIconLucide">
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
                                </Style>
                            </ContentControl.Resources>
                        </ContentControl>

                        <!-- Setting Name and Description -->
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14" Foreground="{DynamicResource PrimaryTextColor}" VerticalAlignment="Center" TextWrapping="Wrap"/>
                            <TextBlock Text="{Binding Description}" FontSize="12" Foreground="{DynamicResource SecondaryTextColor}" TextWrapping="Wrap" Margin="0,2,0,0" VerticalAlignment="Center"/>

                            <!-- Warning Badge -->
                            <Border Background="#FFFACD" CornerRadius="3" Padding="6,3" Margin="0,5,0,0" HorizontalAlignment="Left"
                                    Visibility="{Binding WarningText, Converter={StaticResource InverseNullToVisibilityConverter}}"
                                    BorderBrush="#FFA500" BorderThickness="1">
                                <TextBlock Text="{Binding WarningText}"
                                          FontSize="11"
                                          FontWeight="SemiBold"
                                          Foreground="#8B4513"
                                          TextWrapping="Wrap"/>
                            </Border>

                            <!-- Registry Not Set Indicator -->
                            <Border Background="#D32F2F" CornerRadius="3" Padding="4,2" Margin="0,4,0,0" HorizontalAlignment="Left"
                                    Visibility="{Binding ShowRegistryStateIndicator, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="âš " FontSize="14" Foreground="White" VerticalAlignment="Center"/>
                            </Border>
                        </StackPanel>
                    </StackPanel>

                    <!-- ComboBox for non-power selection settings -->
                    <ComboBox Style="{StaticResource ModernComboBoxStyle}"
                              Grid.Column="1"
                              ItemsSource="{Binding ComboBoxOptions}"
                              SelectedValue="{Binding SelectedValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                              SelectedItem="{Binding NonPowerSelectedItem, Mode=OneWayToSource}"
                              DisplayMemberPath="DisplayText"
                              SelectedValuePath="Value"
                              Width="175"
                              Margin="15,10,15,10"
                              FontWeight="SemiBold"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Panel.ZIndex="10"
                              IsEnabled="{Binding EffectiveIsEnabled}">
                        <ComboBox.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="ComboBox">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="NonPower"/>
                            </MultiBinding>
                        </ComboBox.Visibility>
                    </ComboBox>

                    <!-- Power Plan Selection ComboBox (Special Case) -->
                    <ComboBox Grid.Column="1"
                              ItemsSource="{Binding ComboBoxOptions}"
                              SelectedItem="{Binding PowerPlanSelectedItem, Mode=OneWayToSource}"
                              SelectedValue="{Binding SelectedValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                              SelectedValuePath="Value"
                              ItemTemplate="{StaticResource PowerPlanComboBoxItemTemplate}"
                              Width="175"
                              Margin="15,10,15,10"
                              FontWeight="SemiBold"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Panel.ZIndex="10"
                              IsEnabled="{Binding EffectiveIsEnabled}">
                        <ComboBox.ItemContainerStyle>
                            <Style TargetType="ComboBoxItem" BasedOn="{StaticResource ComboBoxItemStyle}">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="10,8"/>
                                <Setter Property="ToolTip" Value="{x:Null}"/>
                            </Style>
                        </ComboBox.ItemContainerStyle>
                        <ComboBox.Style>
                            <Style TargetType="ComboBox" BasedOn="{StaticResource ModernComboBoxStyle}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SettingDefinition.Id}" Value="power-plan-selection">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ComboBox.Style>
                    </ComboBox>

                    <!-- Single AC ComboBox for power settings without battery -->
                    <ComboBox Style="{StaticResource ModernComboBoxStyle}"
                              Grid.Column="1"
                              ItemsSource="{Binding ComboBoxOptions}"
                              SelectedValue="{Binding ACValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                              SelectedItem="{Binding PowerSettingSelectedItem, Mode=OneWayToSource}"
                              DisplayMemberPath="DisplayText"
                              SelectedValuePath="Value"
                              Width="175"
                              Margin="15,10,15,10"
                              FontWeight="SemiBold"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Panel.ZIndex="10"
                              IsEnabled="{Binding EffectiveIsEnabled}">
                        <ComboBox.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="ComboBox">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="PowerSingleAC"/>
                            </MultiBinding>
                        </ComboBox.Visibility>
                    </ComboBox>

                    <!-- Dual AC/DC ComboBox for power settings with battery -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <StackPanel.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="ComboBox">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="PowerDual"/>
                            </MultiBinding>
                        </StackPanel.Visibility>

                        <!-- AC Power Section -->
                        <StackPanel Orientation="Vertical" Margin="0,0,10,0">
                            <TextBlock Text="Plugged In"
                                       FontSize="10"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource SecondaryTextColor}"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,2"/>
                            <ComboBox ItemsSource="{Binding ComboBoxOptions}"
                                      SelectedValue="{Binding ACValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValuePath="Value"
                                      Width="135"
                                      FontWeight="SemiBold"
                                      IsEnabled="{Binding EffectiveIsEnabled}"/>
                        </StackPanel>

                        <!-- DC Power Section -->
                        <StackPanel Orientation="Vertical">
                            <TextBlock Text="On Battery"
                                       FontSize="10"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource SecondaryTextColor}"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,2"/>
                            <ComboBox ItemsSource="{Binding ComboBoxOptions}"
                                      SelectedValue="{Binding DCValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValuePath="Value"
                                      Width="135"
                                      FontWeight="SemiBold"
                                      IsEnabled="{Binding EffectiveIsEnabled}"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Toggle for binary settings -->
                    <ToggleButton Grid.Column="1" Style="{StaticResource MaterialToggleSwitch}" IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center" Visibility="{Binding InputType, Converter={StaticResource ToggleInputTypeToVisibilityConverter}}" Content="" IsEnabled="{Binding EffectiveIsEnabled}">
                        <ToggleButton.ToolTip>
                            <ToolTip Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                <ContentPresenter Content="{Binding TooltipData}" ContentTemplate="{StaticResource UnifiedSettingsTooltipTemplate}"/>
                            </ToolTip>
                        </ToggleButton.ToolTip>
                    </ToggleButton>

                    <!-- NumericUpDown for non-power numeric settings -->
                    <controls:NumericUpDown Grid.Column="1" Value="{Binding NumericValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}" Units="{Binding Units}" Width="175" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center" IsEnabled="{Binding EffectiveIsEnabled}">
                        <controls:NumericUpDown.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="NumericUpDown">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="NonPower"/>
                            </MultiBinding>
                        </controls:NumericUpDown.Visibility>
                        <controls:NumericUpDown.ToolTip>
                            <ToolTip Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                <ContentPresenter Content="{Binding TooltipData}" ContentTemplate="{StaticResource UnifiedSettingsTooltipTemplate}"/>
                            </ToolTip>
                        </controls:NumericUpDown.ToolTip>
                    </controls:NumericUpDown>

                    <!-- Single AC NumericUpDown for power settings without battery -->
                    <controls:NumericUpDown Grid.Column="1" Value="{Binding ACNumericValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}" Units="{Binding Units}" Width="175" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center" IsEnabled="{Binding EffectiveIsEnabled}">
                        <controls:NumericUpDown.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="NumericUpDown">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="PowerSingleAC"/>
                            </MultiBinding>
                        </controls:NumericUpDown.Visibility>
                        <controls:NumericUpDown.ToolTip>
                            <ToolTip Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                <ContentPresenter Content="{Binding TooltipData}" ContentTemplate="{StaticResource UnifiedSettingsTooltipTemplate}"/>
                            </ToolTip>
                        </controls:NumericUpDown.ToolTip>
                    </controls:NumericUpDown>

                    <!-- Dual AC/DC NumericUpDown for power settings with battery -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <StackPanel.Visibility>
                            <MultiBinding Converter="{StaticResource PowerModeVisibilityConverter}" ConverterParameter="NumericUpDown">
                                <Binding Path="InputType"/>
                                <Binding Path="SupportsSeparateACDC"/>
                                <Binding Path="DataContext.HasBattery" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                <Binding Source="PowerDual"/>
                            </MultiBinding>
                        </StackPanel.Visibility>

                        <!-- AC Power Section -->
                        <StackPanel Orientation="Vertical" Margin="0,0,10,0">
                            <TextBlock Text="Plugged In" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource SecondaryTextColor}" HorizontalAlignment="Center" Margin="0,0,0,2"/>
                            <controls:NumericUpDown Value="{Binding ACNumericValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}" Units="{Binding Units}" Width="135" IsEnabled="{Binding EffectiveIsEnabled}">
                                <controls:NumericUpDown.ToolTip>
                                    <ToolTip Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <ContentPresenter Content="{Binding TooltipData}" ContentTemplate="{StaticResource UnifiedSettingsTooltipTemplate}"/>
                                    </ToolTip>
                                </controls:NumericUpDown.ToolTip>
                            </controls:NumericUpDown>
                        </StackPanel>

                        <!-- DC Power Section -->
                        <StackPanel Orientation="Vertical">
                            <TextBlock Text="On Battery" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource SecondaryTextColor}" HorizontalAlignment="Center" Margin="0,0,0,2"/>
                            <controls:NumericUpDown Value="{Binding DCNumericValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}" Units="{Binding Units}" Width="135" IsEnabled="{Binding EffectiveIsEnabled}">
                                <controls:NumericUpDown.ToolTip>
                                    <ToolTip Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <ContentPresenter Content="{Binding TooltipData}" ContentTemplate="{StaticResource UnifiedSettingsTooltipTemplate}"/>
                                    </ToolTip>
                                </controls:NumericUpDown.ToolTip>
                            </controls:NumericUpDown>
                        </StackPanel>
                    </StackPanel>

                    <!-- Action Button for ActionButton settings -->
                    <Button Grid.Column="1" Effect="{StaticResource UltraLightShadowEffect}" Width="80" Height="30" Content="Apply" Command="{Binding ActionCommand}" Margin="15,10,15,10" HorizontalAlignment="Right" VerticalAlignment="Center" Padding="10,5" Visibility="{Binding InputType, Converter={StaticResource ActionInputTypeToVisibilityConverter}}" IsEnabled="{Binding EffectiveIsEnabled}" Foreground="{DynamicResource PrimaryButtonForeground}" FontFamily="Futura" FontSize="14" FontWeight="SemiBold" Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="Border"
                                        Background="{DynamicResource ElevatedBackground}"
                                        BorderBrush="Transparent"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        Padding="{TemplateBinding Padding}"
                                        RenderTransformOrigin="0.5,0.5">
                                    <Border.RenderTransform>
                                        <ScaleTransform x:Name="ScaleTransform" ScaleX="1" ScaleY="1"/>
                                    </Border.RenderTransform>
                                    <ContentPresenter HorizontalAlignment="Center"
                                                    VerticalAlignment="Center" />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Trigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                                   Storyboard.TargetProperty="ScaleX"
                                                                   To="1.02"
                                                                   Duration="0:0:0.1">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                                   Storyboard.TargetProperty="ScaleY"
                                                                   To="1.02"
                                                                   Duration="0:0:0.1">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </Trigger.EnterActions>
                                        <Trigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                                   Storyboard.TargetProperty="ScaleX"
                                                                   To="1"
                                                                   Duration="0:0:0.1">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                    <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                                   Storyboard.TargetProperty="ScaleY"
                                                                   To="1"
                                                                   Duration="0:0:0.1">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </Trigger.ExitActions>
                                    </Trigger>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter TargetName="Border" Property="Background" Value="Transparent" />
                                        <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource ButtonDisabledBorderBrush}" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <Button.Style>
                            <Style TargetType="Button">
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Foreground" Value="{DynamicResource ButtonDisabledForeground}" />
                                        <Setter Property="Cursor" Value="Arrow" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Loading Overlay -->
                    <Grid Grid.ColumnSpan="2"
                          Visibility="{Binding IsApplying, Converter={StaticResource BooleanToVisibilityConverter}}"
                          Background="#60000000">
                        <iconPacks:PackIconLucide Kind="LoaderCircle"
                                                Width="32"
                                                Height="32"
                                                Foreground="{DynamicResource PrimaryTextColor}"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                RenderTransformOrigin="0.5,0.5">
                            <iconPacks:PackIconLucide.RenderTransform>
                                <RotateTransform/>
                            </iconPacks:PackIconLucide.RenderTransform>
                            <iconPacks:PackIconLucide.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard RepeatBehavior="Forever">
                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                           From="0" To="360" Duration="0:0:1"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </iconPacks:PackIconLucide.Triggers>
                        </iconPacks:PackIconLucide>
                    </Grid>

                    <!-- Lock Overlay for Advanced Settings -->
                    <Border Grid.ColumnSpan="2"
                            Panel.ZIndex="100"
                            Visibility="{Binding IsLocked, Converter={StaticResource BooleanToVisibilityConverter}}"
                            Background="#80000000"
                            CornerRadius="4"
                            Cursor="Hand">
                        <Border.InputBindings>
                            <MouseBinding Command="{Binding UnlockCommand}" MouseAction="LeftClick"/>
                        </Border.InputBindings>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <iconPacks:PackIconMaterial Kind="LockOutline"
                                                         Width="24"
                                                         Height="24"
                                                         Foreground="#FFA500"
                                                         HorizontalAlignment="Center"/>
                            <TextBlock Text="Click to unlock"
                                       FontSize="12"
                                       Foreground="#CCCCCC"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </DataTemplate>

    <!-- Content Section Template -->
    <ControlTemplate x:Key="ContentSectionTemplate" TargetType="ContentControl">
        <Border Background="{DynamicResource ContentSectionBorderBrush}" CornerRadius="5" Margin="0,0,0,5" Effect="{StaticResource LightShadowEffect}" Visibility="{Binding IsExpanded, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Margin="0,5,0,5">
                <ItemsControl ItemsSource="{Binding Settings}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Vertical"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Grid.ColumnSpan" Value="{Binding IsGroupHeader, Converter={StaticResource BooleanToGridSpanConverter}}"/>
                            <Setter Property="Margin" Value="5,2,5,2"/>
                            <Setter Property="Visibility" Value="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource ModernSettingsItemTemplate}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>
    </ControlTemplate>

    <!-- Grouped Content Section Template -->
    <ControlTemplate x:Key="GroupedContentSectionTemplate" TargetType="ContentControl">
        <Border Background="{DynamicResource ContentSectionBorderBrush}" CornerRadius="5" Margin="0,0,0,5" Effect="{StaticResource LightShadowEffect}" Visibility="{Binding IsExpanded, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ItemsControl Margin="0,5,0,5">
                <ItemsControl.Resources>
                    <CollectionViewSource x:Key="GroupedSettings" Source="{Binding Settings}">
                        <CollectionViewSource.GroupDescriptions>
                            <PropertyGroupDescription PropertyName="GroupName"/>
                        </CollectionViewSource.GroupDescriptions>
                    </CollectionViewSource>
                </ItemsControl.Resources>

                <ItemsControl.ItemsSource>
                    <Binding Source="{StaticResource GroupedSettings}"/>
                </ItemsControl.ItemsSource>

                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Setter Property="Height" Value="0"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ItemsControl.ItemContainerStyle>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource ModernSettingsItemTemplate}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>

                <ItemsControl.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.ContainerStyle>
                            <Style TargetType="GroupItem">
                                <Setter Property="behaviors:GroupItemVisibilityBehavior.Enable" Value="True"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="GroupItem">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Name}"
                                                           FontSize="14"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource PrimaryTextColor}"
                                                           Margin="10,8,10,0"
                                                           Visibility="{Binding Name, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                                                <ItemsPresenter/>
                                            </StackPanel>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </GroupStyle.ContainerStyle>
                        <GroupStyle.Panel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical"/>
                            </ItemsPanelTemplate>
                        </GroupStyle.Panel>
                    </GroupStyle>
                </ItemsControl.GroupStyle>

                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </Border>
    </ControlTemplate>

    <!-- Wizard Step Header Template -->
    <DataTemplate x:Key="WizardStepHeaderTemplate">
        <Border Background="{DynamicResource ContentSectionBorderBrush}"
                CornerRadius="5"
                Margin="0,5,0,5"
                Effect="{StaticResource ShadowEffect}"
                Cursor="Hand"
                ClipToBounds="False"
                Panel.ZIndex="100">
            <Grid Height="60">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <iconPacks:PackIconMaterial Grid.Column="0"
                                          Kind="{Binding Icon}"
                                          Width="32"
                                          Height="32"
                                          Margin="15,0,15,0"
                                          VerticalAlignment="Center"
                                          Foreground="{DynamicResource PrimaryTextColor}"/>

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Title}"
                              FontSize="16"
                              FontWeight="SemiBold"
                              Foreground="{DynamicResource PrimaryTextColor}"/>
                    <TextBlock Text="{Binding StatusText}"
                              FontSize="12"
                              Foreground="{DynamicResource SubTextColor}"
                              Margin="0,2,0,0"/>
                </StackPanel>

                <iconPacks:PackIconMaterial Grid.Column="2"
                                          Kind="{Binding HeaderIcon}"
                                          Width="20"
                                          Height="20"
                                          Margin="0,0,15,0"
                                          VerticalAlignment="Center">
                    <iconPacks:PackIconMaterial.Style>
                        <Style TargetType="iconPacks:PackIconMaterial">
                            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextColor}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsLocked}" Value="True">
                                    <Setter Property="Foreground" Value="#FFA500"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsComplete}" Value="True">
                                    <Setter Property="Foreground" Value="#4CAF50"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </iconPacks:PackIconMaterial.Style>
                </iconPacks:PackIconMaterial>
            </Grid>
        </Border>
    </DataTemplate>

    <!-- Locked Step Overlay Template -->
    <DataTemplate x:Key="LockedStepOverlayTemplate">
        <Border Background="#CC1A1A1A"
                CornerRadius="5"
                Panel.ZIndex="999">
            <Border Background="{DynamicResource ContentSectionBorderBrush}"
                    BorderBrush="#FFA500"
                    BorderThickness="2"
                    CornerRadius="8"
                    Padding="30"
                    MaxWidth="500"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <StackPanel>
                    <iconPacks:PackIconMaterial Kind="LockOutline"
                                              Width="48"
                                              Height="48"
                                              Foreground="#FFA500"
                                              HorizontalAlignment="Center"
                                              Margin="0,0,0,15"/>

                    <TextBlock Text="Complete Previous Step First"
                              FontSize="18"
                              FontWeight="Bold"
                              Foreground="{DynamicResource PrimaryTextColor}"
                              HorizontalAlignment="Center"
                              Margin="0,0,0,10"/>

                    <TextBlock TextWrapping="Wrap"
                              FontSize="14"
                              Foreground="{DynamicResource SubTextColor}"
                              HorizontalAlignment="Center"
                              TextAlignment="Center"
                              Margin="0,0,0,20">
                        <Run Text="You need to extract a Windows ISO "/>
                        <Run Text="(Step 1)" FontWeight="Bold"/>
                        <Run Text=" before you can access this step."/>
                    </TextBlock>

                    <Button Content="Go to Step 1"
                            Command="{Binding NavigateToStepCommand}"
                            CommandParameter="1"
                            Style="{StaticResource PrimaryButtonStyle}"
                            HorizontalAlignment="Center"
                            Padding="20,10"/>
                </StackPanel>
            </Border>
        </Border>
    </DataTemplate>

    <!-- Wizard Action Button Style -->
    <Style x:Key="WizardActionButtonStyle" TargetType="Button">
        <Setter Property="Effect" Value="{StaticResource UltraLightShadowEffect}"/>
        <Setter Property="Foreground" Value="{DynamicResource PrimaryButtonForeground}"/>
        <Setter Property="FontFamily" Value="Futura"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="FontWeight" Value="SemiBold"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="Border"
                            Background="{DynamicResource ElevatedBackground}"
                            BorderBrush="Transparent"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="10,5"
                            RenderTransformOrigin="0.5,0.5">
                        <Border.RenderTransform>
                            <ScaleTransform x:Name="ScaleTransform" ScaleX="1" ScaleY="1"/>
                        </Border.RenderTransform>
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Trigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                       Storyboard.TargetProperty="ScaleX"
                                                       To="1.02"
                                                       Duration="0:0:0.1">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                       Storyboard.TargetProperty="ScaleY"
                                                       To="1.02"
                                                       Duration="0:0:0.1">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.EnterActions>
                            <Trigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                       Storyboard.TargetProperty="ScaleX"
                                                       To="1"
                                                       Duration="0:0:0.1">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                                                       Storyboard.TargetProperty="ScaleY"
                                                       To="1"
                                                       Duration="0:0:0.1">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.ExitActions>
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter TargetName="Border" Property="Background" Value="Transparent"/>
                            <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource ButtonDisabledBorderBrush}"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Style.Triggers>
            <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Foreground" Value="{DynamicResource ButtonDisabledForeground}"/>
                <Setter Property="Cursor" Value="Arrow"/>
            </Trigger>
        </Style.Triggers>
    </Style>

    <!-- Wizard Action Card Template -->
    <DataTemplate x:Key="WizardActionCardTemplate">
        <Border Background="{DynamicResource SettingsItemBackground}"
                CornerRadius="4"
                Effect="{StaticResource UltraLightShadowEffect}"
                Margin="0,0,0,10"
                Opacity="{Binding Opacity}">
            <Grid MinHeight="50">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <iconPacks:PackIconMaterial Grid.Column="0"
                                          Kind="{Binding Icon}"
                                          Width="32"
                                          Height="32"
                                          Margin="15,0,15,0"
                                          VerticalAlignment="Center"
                                          Foreground="{DynamicResource PrimaryTextColor}"/>

                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="0,10,0,10">
                    <TextBlock Text="{Binding Title}"
                              FontSize="14"
                              FontWeight="SemiBold"
                              Foreground="{DynamicResource PrimaryTextColor}"/>
                    <TextBlock Text="{Binding Description}"
                              FontSize="12"
                              Foreground="{Binding DescriptionForeground}"
                              TextWrapping="Wrap"
                              Margin="0,2,0,0"/>
                </StackPanel>

                <Grid Grid.Column="2" Width="40" Height="40" Margin="0,0,0,0">
                    <iconPacks:PackIconLucide Kind="LoaderCircle"
                                             Width="24"
                                             Height="24"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Center"
                                             Foreground="{DynamicResource PrimaryTextColor}"
                                             RenderTransformOrigin="0.5,0.5"
                                             Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <iconPacks:PackIconLucide.RenderTransform>
                            <RotateTransform/>
                        </iconPacks:PackIconLucide.RenderTransform>
                        <iconPacks:PackIconLucide.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                       From="0" To="360" Duration="0:0:1"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </iconPacks:PackIconLucide.Triggers>
                    </iconPacks:PackIconLucide>

                    <iconPacks:PackIconMaterial Kind="CheckCircle"
                                              Width="24"
                                              Height="24"
                                              Foreground="#4CAF50"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"
                                              Visibility="{Binding IsComplete, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <iconPacks:PackIconMaterial Kind="CloseCircle"
                                              Width="24"
                                              Height="24"
                                              Foreground="#F44336"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"
                                              Visibility="{Binding HasFailed, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>

                <Button Grid.Column="3"
                        Content="{Binding ButtonText}"
                        Command="{Binding ButtonCommand}"
                        IsEnabled="{Binding IsEnabled}"
                        Style="{StaticResource WizardActionButtonStyle}"
                        Width="130"
                        Height="30"
                        Margin="15,0,15,0"/>
            </Grid>
        </Border>
    </DataTemplate>

</ResourceDictionary>