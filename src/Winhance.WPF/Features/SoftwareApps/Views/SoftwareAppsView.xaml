<UserControl x:Class="Winhance.WPF.Features.SoftwareApps.Views.SoftwareAppsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:viewModels="clr-namespace:Winhance.WPF.Features.SoftwareApps.ViewModels"
             xmlns:views="clr-namespace:Winhance.WPF.Features.SoftwareApps.Views"
             xmlns:commonControls="clr-namespace:Winhance.WPF.Features.Common.Controls"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:loc="clr-namespace:Winhance.WPF.Features.Common.Extensions"
             d:DataContext="{d:DesignInstance Type=viewModels:SoftwareAppsViewModel}"
             mc:Ignorable="d">

    <UserControl.Resources>
        <!-- Direct DataTemplates for Windows Apps -->
        <DataTemplate x:Key="ListViewTemplate"
                DataType="{x:Type viewModels:WindowsAppsViewModel}">
            <views:WindowsAppsView />
        </DataTemplate>

        <DataTemplate x:Key="TableViewTemplate"
                DataType="{x:Type viewModels:WindowsAppsViewModel}">
            <views:WindowsAppsTableView />
        </DataTemplate>

        <!-- Direct DataTemplates for External Apps -->
        <DataTemplate x:Key="ExternalListViewTemplate"
                DataType="{x:Type viewModels:ExternalAppsViewModel}">
            <views:ExternalAppsView />
        </DataTemplate>

        <DataTemplate x:Key="ExternalTableViewTemplate"
                DataType="{x:Type viewModels:ExternalAppsViewModel}">
            <views:ExternalAppsTableView />
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <!-- Header -->
        <Grid x:Name="HeaderGrid"
              Height="80"
              VerticalAlignment="Top"
              ClipToBounds="False">
            <Viewbox Stretch="Uniform"
                     StretchDirection="DownOnly"
                     HorizontalAlignment="Stretch">
                <Grid Width="{Binding ActualWidth, ElementName=HeaderGrid}"
                      MinWidth="1250"
                      MinHeight="80">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <!-- Icon -->
                        <ColumnDefinition Width="Auto" />
                        <!-- Text -->
                        <ColumnDefinition Width="*" />
                        <!-- Spacer -->
                        <ColumnDefinition Width="Auto" />
                        <!-- Buttons -->
                    </Grid.ColumnDefinitions>

                    <!-- Icon (Col 0) -->
                    <iconPacks:PackIconMaterial Grid.Column="0"
                                             Kind="PackageVariant"
                                             Width="60"
                                             Height="60"
                                             Margin="10,0,10,0"
                                             VerticalAlignment="Center"
                                             Foreground="{DynamicResource PrimaryTextColor}" />

                    <!-- Title and Status (Col 1) -->
                    <StackPanel Grid.Column="1"
                                VerticalAlignment="Center">
                        <TextBlock Height="35"
                                   VerticalAlignment="Top"
                                   FontFamily="Helvetica Neue"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource PrimaryTextColor}"
                                   Text="{loc:Localize Category_SoftwareApps_Title}" />

                        <StackPanel Orientation="Horizontal"
                                    Margin="0,5,0,0">
                            <TextBlock Height="22"
                                       VerticalAlignment="Center"
                                       FontFamily="Helvetica Neue"
                                       FontSize="14"
                                       Foreground="{DynamicResource SubTextColor}"
                                       Text="{loc:Localize Category_SoftwareApps_StatusText}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Buttons and Search (Col 2) -->
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                VerticalAlignment="Bottom"
                                HorizontalAlignment="Right"
                                Margin="0,0,0,0">

                        <!-- Buttons Row 1 -->
                        <StackPanel Orientation="Horizontal">
                            <!-- Commented out View mode toggle -->
                        </StackPanel>

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <!-- Install Selected Items Button -->
                            <Button Style="{StaticResource InstallAppsButtonStyle}"
                                    Content="{loc:Localize SoftwareApps_Button_InstallSelected}"
                                    MinWidth="180"
                                    Width="Auto"
                                    Height="35"
                                    Margin="0,0,5,1"
                                    Command="{Binding InstallSelectedItemsCommand}"
                                    IsEnabled="{Binding CanInstallItems}" />

                            <!-- Separator -->
                            <Border Width="1"
                                    Height="28"
                                    Background="#505050"
                                    VerticalAlignment="Center"
                                    Margin="0,0,5,0" />

                            <!-- Remove Selected Items Button -->
                            <Button Style="{StaticResource RemoveAppsButtonStyle}"
                                    Content="{Binding RemoveButtonText}"
                                    MinWidth="180"
                                    Width="Auto"
                                    Height="35"
                                    Margin="0,0,5,1"
                                    Command="{Binding RemoveSelectedItemsCommand}"
                                    IsEnabled="{Binding CanRemoveItems}" />

                            <!-- Separator -->
                            <Border Width="1"
                                    Height="28"
                                    Background="#505050"
                                    VerticalAlignment="Center"
                                    Margin="0,0,5,0" />

                            <!-- Refresh Button -->
                            <Button Style="{StaticResource RefreshButtonStyle}"
                                    Content="{loc:Localize Button_Refresh}"
                                    MinWidth="90"
                                    Width="Auto"
                                    Height="35"
                                    Margin="0,0,5,1"
                                    Command="{Binding RefreshInstallationStatusCommand}">
                                <Button.ToolTip>
                                    <TextBlock Text="{loc:Localize Tooltip_RefreshInstallationStatus}" />
                                </Button.ToolTip>
                            </Button>

                            <!-- Separator -->
                            <Border Width="1"
                                    Height="28"
                                    Background="#505050"
                                    VerticalAlignment="Center"
                                    Margin="0,0,10,0" />

                            <!-- Help Button -->
                            <Button x:Name="HelpButton"
                                    Content="{loc:Localize Button_Help}"
                                    MinWidth="60"
                                    Width="Auto"
                                    Height="35"
                                    Margin="0,0,0,1"
                                    Command="{Binding ShowHelpCommand}"
                                    VerticalAlignment="Center"
                                    Loaded="HelpButton_Loaded">
                                <Button.Style>
                                    <Style TargetType="Button"
                                            BasedOn="{StaticResource HelpButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsHelpButtonActive}"
                                                    Value="True">
                                                <Setter Property="Background"
                                                        Value="{DynamicResource ButtonBorderBrush}" />
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource ButtonHoverTextColor}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Search Box -->
                            <commonControls:SearchBox
                                    Width="200"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    SearchText="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    Margin="0,0,0,1" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Viewbox>
        </Grid>

        <!-- Main Content -->
        <Border Margin="0,85,0,0"
                Background="{DynamicResource MainContainerBorderBrush}"
                CornerRadius="10">
            <Grid>
                <!-- Sticky Tab Header Section -->
                <Border Height="80"
                        VerticalAlignment="Top"
                        Background="{DynamicResource MainContainerBorderBrush}"
                        CornerRadius="10,10,0,0"
                        Padding="15,20,15,10"
                        Panel.ZIndex="100">
                    <Border Style="{StaticResource AppSectionHeaderStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Windows Apps Tab -->
                            <Grid Grid.Column="0">
                                <!-- Selection Indicator -->
                                <Border Width="3"
                                        Height="20"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Background="{DynamicResource ButtonHoverBackground}"
                                        Margin="5,0,0,0"
                                        CornerRadius="1.5"
                                        Visibility="{Binding IsWindowsAppsTabSelected, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Panel.ZIndex="1" />

                                <!-- Tab Content -->
                                <Border x:Name="WindowsAppsTab"
                                        Cursor="Hand"
                                        Background="Transparent"
                                        CornerRadius="5"
                                        Focusable="True"
                                        FocusVisualStyle="{StaticResource AccessibleFocusVisual}"
                                        AutomationProperties.Name="{loc:Localize Accessibility_WindowsAppsTab}">
                                    <Border.Resources>
                                        <Style x:Key="TabHoverStyle"
                                                TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                        Value="True">
                                                    <Setter Property="Background"
                                                            Value="{DynamicResource MainContainerBorderBrush}" />
                                                </Trigger>
                                                <DataTrigger Binding="{Binding IsWindowsAppsTabSelected}"
                                                        Value="True">
                                                    <Setter Property="Background"
                                                            Value="{DynamicResource MainContainerBorderBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Resources>
                                    <Border.Style>
                                        <StaticResource ResourceKey="TabHoverStyle" />
                                    </Border.Style>
                                    <Grid x:Name="WindowsAppsTabGrid">
                                        <!-- Inner border for selected tab or hover -->
                                        <Border x:Name="WindowsAppsInnerBorder"
                                                Margin="4"
                                                CornerRadius="3"
                                                BorderThickness="1"
                                                BorderBrush="{DynamicResource MainContainerBorderBrush}"
                                                Background="{DynamicResource MainContainerBorderBrush}">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility"
                                                            Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsWindowsAppsTabSelected}"
                                                                Value="True">
                                                            <Setter Property="Visibility"
                                                                    Value="Visible" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding ElementName=WindowsAppsTab, Path=IsMouseOver}"
                                                                Value="True">
                                                            <Setter Property="Visibility"
                                                                    Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                        <DockPanel VerticalAlignment="Center"
                                                HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="MicrosoftWindows"
                                                    Width="20"
                                                    Height="20"
                                                    Margin="5,0,0,0"
                                                    VerticalAlignment="Center"
                                                    Foreground="{DynamicResource PrimaryTextColor}" />
                                            <TextBlock Text="{loc:Localize SoftwareApps_Tab_WindowsApps}"
                                                    Style="{StaticResource AppSectionHeaderTextStyle}"
                                                    Margin="0,0,5,0" />
                                        </DockPanel>
                                    </Grid>
                                    <Border.InputBindings>
                                        <MouseBinding MouseAction="LeftClick"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="True" />
                                        <KeyBinding Key="Enter"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="True" />
                                        <KeyBinding Key="Space"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="True" />
                                    </Border.InputBindings>
                                </Border>
                            </Grid>

                            <!-- Separator -->
                            <Border Grid.Column="1"
                                    Width="1"
                                    Height="25"
                                    Margin="0,5"
                                    VerticalAlignment="Stretch"
                                    Background="#AAAAAA" />

                            <!-- External Software Tab -->
                            <Grid Grid.Column="2">
                                <!-- Selection Indicator -->
                                <Border Width="3"
                                        Height="20"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Background="{DynamicResource ButtonHoverBackground}"
                                        Margin="5,0,0,0"
                                        CornerRadius="1.5"
                                        Visibility="{Binding IsExternalAppsTabSelected, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Panel.ZIndex="1" />

                                <!-- Tab Content -->
                                <Border x:Name="ExternalAppsTab"
                                        Cursor="Hand"
                                        Background="Transparent"
                                        CornerRadius="5"
                                        Focusable="True"
                                        FocusVisualStyle="{StaticResource AccessibleFocusVisual}"
                                        AutomationProperties.Name="{loc:Localize Accessibility_ExternalAppsTab}">
                                    <Border.Resources>
                                        <Style x:Key="TabHoverStyle"
                                                TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                        Value="True">
                                                    <Setter Property="Background"
                                                            Value="{DynamicResource MainContainerBorderBrush}" />
                                                </Trigger>
                                                <DataTrigger Binding="{Binding IsExternalAppsTabSelected}"
                                                        Value="True">
                                                    <Setter Property="Background"
                                                            Value="{DynamicResource MainContainerBorderBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Resources>
                                    <Border.Style>
                                        <StaticResource ResourceKey="TabHoverStyle" />
                                    </Border.Style>
                                    <Grid x:Name="ExternalAppsTabGrid">
                                        <!-- Inner border for selected tab or hover -->
                                        <Border x:Name="ExternalAppsInnerBorder"
                                                Margin="4"
                                                CornerRadius="3"
                                                BorderThickness="1"
                                                BorderBrush="{DynamicResource MainContainerBorderBrush}"
                                                Background="{DynamicResource MainContainerBorderBrush}">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility"
                                                            Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsExternalAppsTabSelected}"
                                                                Value="True">
                                                            <Setter Property="Visibility"
                                                                    Value="Visible" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding ElementName=ExternalAppsTab, Path=IsMouseOver}"
                                                                Value="True">
                                                            <Setter Property="Visibility"
                                                                    Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                        <DockPanel VerticalAlignment="Center"
                                                HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="PackageDown"
                                                                     Width="20"
                                                                     Height="20"
                                                                     Margin="5,0,0,0"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{DynamicResource PrimaryTextColor}" />
                                            <TextBlock Text="{loc:Localize SoftwareApps_Tab_ExternalApps}"
                                                    Style="{StaticResource AppSectionHeaderTextStyle}"
                                                    Margin="0,0,5,0" />
                                        </DockPanel>
                                    </Grid>
                                    <Border.InputBindings>
                                        <MouseBinding MouseAction="LeftClick"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="False" />
                                        <KeyBinding Key="Enter"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="False" />
                                        <KeyBinding Key="Space"
                                                Command="{Binding SelectTabCommand}"
                                                CommandParameter="False" />
                                    </Border.InputBindings>
                                </Border>
                            </Grid>
                        </Grid>
                    </Border>
                </Border>

                <!-- Scrollable Content Section -->
                <Border Margin="0,85,0,0"
                        CornerRadius="0,0,10,10">
                    <commonControls:ResponsiveScrollViewer Style="{StaticResource ModernScrollViewer}"
                                                           commonControls:ResponsiveScrollViewer.ScrollPositionCommand="{Binding UpdateScrollPositionCommand}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0"
                                    Margin="10">
                                <!-- Content Section -->
                                <Border Style="{StaticResource AppSectionContentBorderStyle}">
                                    <Grid>
                                        <!-- Windows Apps Content -->
                                        <Grid Visibility="{Binding WindowsAppsContentVisibility}">
                                            <!-- Table View Mode - Shows when IsTableViewMode is true -->
                                            <ContentControl Content="{Binding WindowsAppsViewModel}"
                                                    ContentTemplate="{StaticResource TableViewTemplate}">
                                                <ContentControl.Style>
                                                    <Style TargetType="ContentControl">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding WindowsAppsViewModel.IsTableViewMode}"
                                                                    Value="True">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ContentControl.Style>
                                            </ContentControl>

                                            <!-- List View Mode - Shows when IsTableViewMode is false -->
                                            <ContentControl Content="{Binding WindowsAppsViewModel}"
                                                    ContentTemplate="{StaticResource ListViewTemplate}">
                                                <ContentControl.Style>
                                                    <Style TargetType="ContentControl">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding WindowsAppsViewModel.IsTableViewMode}"
                                                                    Value="False">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ContentControl.Style>
                                            </ContentControl>
                                        </Grid>

                                        <!-- External Apps Content -->
                                        <Grid Visibility="{Binding ExternalAppsContentVisibility}">
                                            <!-- Table View Mode - Shows when IsTableViewMode is true -->
                                            <ContentControl Content="{Binding ExternalAppsViewModel}"
                                                    ContentTemplate="{StaticResource ExternalTableViewTemplate}">
                                                <ContentControl.Style>
                                                    <Style TargetType="ContentControl">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ExternalAppsViewModel.IsTableViewMode}"
                                                                    Value="True">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ContentControl.Style>
                                            </ContentControl>

                                            <!-- List View Mode - Shows when IsTableViewMode is false -->
                                            <ContentControl Content="{Binding ExternalAppsViewModel}"
                                                    ContentTemplate="{StaticResource ExternalListViewTemplate}">
                                                <ContentControl.Style>
                                                    <Style TargetType="ContentControl">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ExternalAppsViewModel.IsTableViewMode}"
                                                                    Value="False">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ContentControl.Style>
                                            </ContentControl>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <Border Grid.Row="1"
                                    Height="20" />
                        </Grid>
                    </commonControls:ResponsiveScrollViewer>
                </Border>

                <!-- Loading Overlay -->
                <commonControls:ContentLoadingOverlay
                    Panel.ZIndex="200"
                    Margin="0,85,0,0"
                    IsVisible="{Binding IsRefreshingContent}"
                    StatusMessage="Refreshing installation status..." />
            </Grid>
        </Border>

        <!-- Help Flyout Popup - renders at window level, above all overlays -->
        <Popup x:Name="HelpFlyoutPopup"
               IsOpen="{Binding IsHelpFlyoutVisible}"
               PlacementTarget="{Binding ElementName=HelpFlyoutOverlay}"
               Placement="Relative"
               AllowsTransparency="True"
               StaysOpen="False"
               Closed="HelpFlyoutPopup_Closed">
            <Popup.HorizontalOffset>
                <Binding Path="HelpFlyoutLeft" />
            </Popup.HorizontalOffset>
            <Popup.VerticalOffset>
                <Binding Path="HelpFlyoutTop" />
            </Popup.VerticalOffset>

            <!-- The flyout help content -->
            <ContentControl x:Name="HelpFlyoutContent"
                           Content="{Binding CurrentHelpContent}" />
        </Popup>

        <!-- Invisible overlay for click detection -->
        <Grid x:Name="HelpFlyoutOverlay"
              Background="Transparent"
              Visibility="{Binding IsHelpFlyoutVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
              MouseLeftButtonDown="HelpFlyoutOverlay_MouseLeftButtonDown"
              KeyDown="HelpFlyoutOverlay_KeyDown"
              Focusable="True"
              Panel.ZIndex="1001" />
    </Grid>
</UserControl>