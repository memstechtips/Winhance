<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Winhance.UI.Features.Customize.CustomizePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Winhance.UI.Features.Customize"
    xmlns:viewModels="using:Winhance.UI.Features.Optimize.ViewModels"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:commonControls="using:Winhance.UI.Features.Common.Controls"
    x:DefaultBindMode="OneWay"
    NavigationCacheMode="Enabled">

    <Page.Resources>
        <!-- ItemTemplate: SettingsCard wraps the shared SettingsCardItem control -->
        <DataTemplate x:Key="SettingItemTemplate" x:DataType="viewModels:SettingItemViewModel">
            <controls:SettingsCard
                Header="{x:Bind Name}"
                Description="{x:Bind Description}"
                IsEnabled="{x:Bind EffectiveIsEnabled}"
                Visibility="{x:Bind IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                HeaderIcon="{x:Bind Converter={StaticResource SettingIconConverter}}"
                Padding="16,12,16,12">
                <commonControls:SettingsCardItem Setting="{x:Bind}"/>
            </controls:SettingsCard>
        </DataTemplate>
    </Page.Resources>

    <Grid Padding="0,0,12,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Page Header with Icon -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16">
            <Viewbox Width="64" Height="64" Stretch="Uniform">
                <PathIcon Data="{StaticResource CustomizeIconPath}"/>
            </Viewbox>
            <StackPanel VerticalAlignment="Center">
                <TextBlock
                    Text="{x:Bind ViewModel.PageTitle}"
                    Style="{StaticResource TitleTextBlockStyle}"
                    FontWeight="Bold"
                    FontSize="30"/>
                <TextBlock
                    Text="{x:Bind ViewModel.PageDescription}"
                    Style="{StaticResource CaptionTextBlockStyle}"
                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                    Margin="0,2,0,0"/>
            </StackPanel>
        </StackPanel>

        <!-- Search Box Row -->
        <Grid Grid.Row="1" Margin="0,12,0,16" HorizontalAlignment="Right">
            <Grid Width="220">
                <TextBox
                    x:Name="SearchTextBox"
                    PlaceholderText="Search settings..."
                    Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Padding="8,4,36,4"
                    MinHeight="0"/>
                <FontIcon
                    Glyph="{StaticResource SearchIconGlyph}"
                    FontSize="12"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Margin="0,0,10,0"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    IsHitTestVisible="False"/>
            </Grid>
        </Grid>

        <!-- Loading State -->
        <ProgressRing
            Grid.Row="2"
            IsActive="{x:Bind ViewModel.IsLoading}"
            Visibility="{x:Bind ViewModel.IsLoading}"
            Width="48"
            Height="48"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"/>

        <!-- Main Content - Feature Sections -->
        <ScrollView
            Grid.Row="2"
            Visibility="{x:Bind ViewModel.IsNotLoading}">
            <StackPanel Spacing="8" MaxWidth="{StaticResource SettingsContentMaxWidth}" Margin="{StaticResource SettingsContentMargin}" HorizontalAlignment="Stretch">

                <!-- Explorer Customizations -->
                <controls:SettingsExpander
                    x:Name="ExplorerExpander"
                    Header="{x:Bind ViewModel.ExplorerViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.ExplorerViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.ExplorerViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.ExplorerViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource ExplorerIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Start Menu Customizations -->
                <controls:SettingsExpander
                    x:Name="StartMenuExpander"
                    Header="{x:Bind ViewModel.StartMenuViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.StartMenuViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.StartMenuViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.StartMenuViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource StartMenuIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Taskbar Customizations -->
                <controls:SettingsExpander
                    x:Name="TaskbarExpander"
                    Header="{x:Bind ViewModel.TaskbarViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.TaskbarViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.TaskbarViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.TaskbarViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource TaskbarIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Windows Theme Customizations -->
                <controls:SettingsExpander
                    x:Name="WindowsThemeExpander"
                    Header="{x:Bind ViewModel.WindowsThemeViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.WindowsThemeViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.WindowsThemeViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.WindowsThemeViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource WindowsThemeIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- No Results Message -->
                <TextBlock
                    Text="No settings match your search."
                    Style="{StaticResource BodyTextBlockStyle}"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    HorizontalAlignment="Center"
                    Margin="0,40,0,0"
                    Visibility="{x:Bind ViewModel.HasNoSearchResults, Converter={StaticResource BooleanToVisibilityConverter}}"/>

            </StackPanel>
        </ScrollView>
    </Grid>
</Page>
