<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Winhance.UI.Features.Optimize.OptimizePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Winhance.UI.Features.Optimize"
    xmlns:viewModels="using:Winhance.UI.Features.Optimize.ViewModels"
    xmlns:models="using:Winhance.UI.Features.Common.Models"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:commonControls="using:Winhance.UI.Features.Common.Controls"
    x:DefaultBindMode="OneWay"
    NavigationCacheMode="Required">

    <Page.Resources>
        <!-- Badge ItemTemplate -->
        <DataTemplate x:Key="BadgeItemTemplate" x:DataType="models:SettingBadgeInfo">
            <commonControls:SettingBadge
                BadgeType="{x:Bind Type}"
                Text="{x:Bind Text}"
                Tooltip="{x:Bind Tooltip}"/>
        </DataTemplate>

        <!-- ItemTemplate: SettingsCard wraps the shared SettingsCardItem control -->
        <DataTemplate x:Key="SettingItemTemplate" x:DataType="viewModels:SettingItemViewModel">
            <controls:SettingsCard
                Visibility="{x:Bind IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                Header="{x:Bind Name}"
                Description="{x:Bind Description}"
                IsEnabled="{x:Bind EffectiveIsEnabled}"
                HeaderIcon="{x:Bind Converter={StaticResource SettingIconConverter}}"
                Padding="16,12,16,12">
                <!-- Content: Grid overlay - badge at top-right, control centered -->
                <Grid MinHeight="32">
                    <!-- Badges (top-right corner, floating) -->
                    <ItemsControl
                        ItemsSource="{x:Bind Badges}"
                        Visibility="{x:Bind HasBadges, Converter={StaticResource BooleanToVisibilityConverter}}"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Right"
                        Margin="0,-8,0,0"
                        ItemTemplate="{StaticResource BadgeItemTemplate}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                    <!-- Setting control (centered) -->
                    <commonControls:SettingsCardItem Setting="{x:Bind}" VerticalAlignment="Center" HorizontalAlignment="Right"/>
                </Grid>
            </controls:SettingsCard>
        </DataTemplate>
    </Page.Resources>

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Page Header -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                <Viewbox Width="56" Height="56" Stretch="Uniform">
                    <PathIcon Data="{StaticResource OptimizeIconPath}" Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                </Viewbox>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock
                        Text="Optimize"
                        Style="{StaticResource TitleTextBlockStyle}"/>
                    <TextBlock
                        Text="Fine-tune Windows settings for better performance"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </StackPanel>

            <!-- Search Box -->
            <Grid Grid.Column="2" Width="250">
                <TextBox
                    x:Name="SearchTextBox"
                    PlaceholderText="Search settings..."
                    Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Padding="8,8,36,8"/>
                <FontIcon
                    Glyph="{StaticResource SearchIconGlyph}"
                    FontSize="14"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Margin="0,0,12,0"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    IsHitTestVisible="False"/>
            </Grid>
        </Grid>

        <!-- Loading State -->
        <ProgressRing
            Grid.Row="2"
            IsActive="{x:Bind ViewModel.IsLoading}"
            Visibility="{x:Bind ViewModel.IsLoading}"
            Width="48"
            Height="48"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"/>

        <!-- Main Content - Feature Sections -->
        <ScrollView
            Grid.Row="2"
            Visibility="{x:Bind ViewModel.IsNotLoading}">
            <StackPanel Spacing="8" MaxWidth="{StaticResource SettingsContentMaxWidth}" Margin="{StaticResource SettingsContentMargin}" HorizontalAlignment="Stretch">

                <!-- Sound Optimizations -->
                <controls:SettingsExpander
                    x:Name="SoundExpander"
                    Header="{x:Bind ViewModel.SoundViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.SoundViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.SoundViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.SoundViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource SoundIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Update Optimizations -->
                <controls:SettingsExpander
                    x:Name="UpdateExpander"
                    Header="{x:Bind ViewModel.UpdateViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.UpdateViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.UpdateViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.UpdateViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource UpdateIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Notification Optimizations -->
                <controls:SettingsExpander
                    x:Name="NotificationExpander"
                    Header="{x:Bind ViewModel.NotificationViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.NotificationViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.NotificationViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.NotificationViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource NotificationIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Privacy Optimizations -->
                <controls:SettingsExpander
                    x:Name="PrivacyExpander"
                    Header="{x:Bind ViewModel.PrivacyViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.PrivacyViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.PrivacyViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.PrivacyViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource PrivacyIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Power Optimizations -->
                <controls:SettingsExpander
                    x:Name="PowerExpander"
                    Header="{x:Bind ViewModel.PowerViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.PowerViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.PowerViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.PowerViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource PowerIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- Gaming & Performance Optimizations -->
                <controls:SettingsExpander
                    x:Name="GamingExpander"
                    Header="{x:Bind ViewModel.GamingViewModel.DisplayName}"
                    IsExpanded="{x:Bind ViewModel.GamingViewModel.IsExpanded, Mode=TwoWay}"
                    Visibility="{x:Bind ViewModel.GamingViewModel.HasVisibleSettings, Converter={StaticResource BooleanToVisibilityConverter}}"
                    ItemsSource="{x:Bind ViewModel.GamingViewModel.Settings}"
                    ItemTemplate="{StaticResource SettingItemTemplate}">
                    <controls:SettingsExpander.HeaderIcon>
                        <FontIcon Glyph="{StaticResource GamingIconGlyph}" FontFamily="Segoe MDL2 Assets"/>
                    </controls:SettingsExpander.HeaderIcon>
                </controls:SettingsExpander>

                <!-- No Results Message -->
                <TextBlock
                    Text="No settings match your search."
                    Style="{StaticResource BodyTextBlockStyle}"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    HorizontalAlignment="Center"
                    Margin="0,40,0,0"
                    Visibility="{x:Bind ViewModel.HasNoSearchResults, Converter={StaticResource BooleanToVisibilityConverter}}"/>

            </StackPanel>
        </ScrollView>
    </Grid>
</Page>
